# Database Migrations with Alembic

This guide covers database migration management using Alembic in the BookStore API project.

## üìã Table of Contents

- [Overview](#overview)
- [Quick Start](#quick-start)
- [Migration Commands](#migration-commands)
- [Development Workflow](#development-workflow)
- [Production Deployment](#production-deployment)
- [Troubleshooting](#troubleshooting)
- [Best Practices](#best-practices)

## üéØ Overview

Alembic is a database migration tool for SQLAlchemy that provides:

- **Version Control** for database schema changes
- **Automatic Migration Generation** from model changes
- **Rollback Capabilities** for safe deployments
- **Team Synchronization** of database schemas
- **Production-Safe** migration procedures

### Why Alembic?

Before Alembic, we used `Base.metadata.create_all()` which had limitations:
- ‚ùå No version tracking
- ‚ùå No rollback capability
- ‚ùå Couldn't modify existing tables
- ‚ùå Team synchronization issues

With Alembic:
- ‚úÖ Full version control
- ‚úÖ Safe rollbacks
- ‚úÖ Incremental schema changes
- ‚úÖ Team collaboration
- ‚úÖ Production deployment safety

## üöÄ Quick Start

### 1. Check Migration Status
```bash
# Using our migration script
python scripts/migrate.py status

# Or directly with Alembic
alembic current
```

### 2. Create Your First Migration
```bash
# Make changes to models in bookstore/models.py
# Then generate migration
python scripts/migrate.py create "Add user preferences" --autogenerate

# Or with Alembic directly
alembic revision --autogenerate -m "Add user preferences"
```

### 3. Apply Migration
```bash
# Upgrade to latest
python scripts/migrate.py upgrade

# Or with Alembic
alembic upgrade head
```

## üîß Migration Commands

### Using Migration Script (Recommended)

Our custom script provides enhanced functionality:

```bash
# Show current status
python scripts/migrate.py status

# Create new migration
python scripts/migrate.py create "Migration message" --autogenerate

# Upgrade database
python scripts/migrate.py upgrade

# Downgrade by one step
python scripts/migrate.py downgrade

# Show migration history
python scripts/migrate.py history --verbose

# Reset database (development only)
python scripts/migrate.py reset --force

# Validate migration consistency
python scripts/migrate.py validate
```

### Using Alembic Directly

```bash
# Basic commands
alembic current                    # Show current revision
alembic history                    # Show migration history
alembic upgrade head              # Upgrade to latest
alembic downgrade -1              # Downgrade by one
alembic revision --autogenerate -m "Message"  # Create migration

# Advanced commands
alembic upgrade +2                # Upgrade by 2 steps
alembic downgrade abc123          # Downgrade to specific revision
alembic stamp head               # Mark database as current without running migrations
alembic show abc123              # Show specific migration
```

## üë®‚Äçüíª Development Workflow

### 1. Making Model Changes

Edit your models in `bookstore/models.py`:

```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    email = Column(String(255), unique=True, nullable=False)
    username = Column(String(100), unique=True, nullable=False)
    
    # Add new field
    phone_number = Column(String(20), nullable=True)  # New field
    
    # Add new relationship
    preferences = relationship("UserPreference", back_populates="user")
```

### 2. Generate Migration

```bash
# Auto-generate migration from model changes
python scripts/migrate.py create "Add phone number and preferences" --autogenerate
```

This creates a file like:
```
alembic/versions/20260112_1800_abc123_add_phone_number_and_preferences.py
```

### 3. Review Migration

Always review the generated migration:

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('phone_number', sa.String(length=20), nullable=True))
    op.create_table('user_preferences',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
        sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('user_preferences')
    op.drop_column('users', 'phone_number')
    # ### end Alembic commands ###
```

### 4. Apply Migration

```bash
# Apply the migration
python scripts/migrate.py upgrade
```

### 5. Test and Commit

```bash
# Test your changes
python -m pytest tests/

# Commit both model changes and migration
git add bookstore/models.py alembic/versions/
git commit -m "Add phone number and user preferences"
```

## üè≠ Production Deployment

### Pre-Deployment Checklist

- [ ] All migrations tested in staging
- [ ] Database backup created
- [ ] Rollback plan prepared
- [ ] Downtime window scheduled (if needed)
- [ ] Team notified

### Deployment Steps

1. **Backup Database**
```bash
# Create backup before migration
make db-backup
```

2. **Apply Migrations**
```bash
# In production environment
python scripts/migrate.py status    # Check current state
python scripts/migrate.py upgrade   # Apply migrations
```

3. **Verify Deployment**
```bash
# Check migration status
python scripts/migrate.py status

# Test application
curl https://api.yourdomain.com/health
```

### Rollback Procedure

If something goes wrong:

```bash
# Rollback to previous migration
python scripts/migrate.py downgrade

# Or rollback to specific revision
python scripts/migrate.py downgrade abc123

# Restore from backup if needed
make db-restore BACKUP_FILE=/path/to/backup.sql
```

## üîç Troubleshooting

### Common Issues

#### 1. Multiple Heads
```
FAILED: Multiple head revisions are present
```

**Solution:**
```bash
# Merge the heads
alembic merge heads -m "Merge migrations"
alembic upgrade head
```

#### 2. Migration Conflicts
```
FAILED: Can't locate revision identified by 'abc123'
```

**Solution:**
```bash
# Check migration history
python scripts/migrate.py history

# Validate consistency
python scripts/migrate.py validate

# If needed, stamp to correct revision
alembic stamp head
```

#### 3. Schema Drift
Database schema doesn't match models.

**Solution:**
```bash
# Generate migration to fix drift
python scripts/migrate.py create "Fix schema drift" --autogenerate

# Review and apply
python scripts/migrate.py upgrade
```

#### 4. Failed Migration
Migration fails partway through.

**Solution:**
```bash
# Check current state
python scripts/migrate.py status

# Manual fix might be needed
# Edit migration file or database directly
# Then stamp to correct revision
alembic stamp abc123
```

### Debug Mode

Enable verbose logging:

```bash
# Set log level in alembic.ini
[logger_alembic]
level = DEBUG

# Or use verbose flag
alembic -x verbose=true upgrade head
```

## üìö Best Practices

### 1. Migration Naming

Use descriptive names:
```bash
# Good
python scripts/migrate.py create "Add user email verification"
python scripts/migrate.py create "Create order tracking table"
python scripts/migrate.py create "Add index on user email"

# Bad
python scripts/migrate.py create "Update users"
python scripts/migrate.py create "Fix stuff"
```

### 2. Review All Migrations

- Always review auto-generated migrations
- Check for data loss operations
- Verify foreign key constraints
- Test with sample data

### 3. Incremental Changes

Make small, focused migrations:
```python
# Good - single purpose
def upgrade():
    op.add_column('users', sa.Column('phone', sa.String(20)))

# Bad - multiple unrelated changes
def upgrade():
    op.add_column('users', sa.Column('phone', sa.String(20)))
    op.create_table('orders', ...)
    op.drop_column('products', 'old_field')
```

### 4. Data Migrations

For data changes, use separate migrations:
```python
def upgrade():
    # Schema change
    op.add_column('users', sa.Column('full_name', sa.String(255)))
    
    # Data migration
    connection = op.get_bind()
    connection.execute(
        "UPDATE users SET full_name = first_name || ' ' || last_name"
    )
    
    # Cleanup
    op.drop_column('users', 'first_name')
    op.drop_column('users', 'last_name')
```

### 5. Testing Migrations

Test both upgrade and downgrade:
```bash
# Test upgrade
python scripts/migrate.py upgrade

# Test downgrade
python scripts/migrate.py downgrade

# Test upgrade again
python scripts/migrate.py upgrade
```

### 6. Production Safety

- Never run migrations directly in production
- Always test in staging first
- Use deployment scripts
- Have rollback procedures ready

### 7. Team Collaboration

- Commit migrations with code changes
- Resolve migration conflicts promptly
- Communicate schema changes to team
- Use descriptive commit messages

## üîó Related Documentation

- [Alembic Official Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [Database Setup Guide](DATABASE_SETUP.md)
- [Production Deployment Guide](PRODUCTION_DEPLOYMENT.md)

## üÜò Getting Help

If you encounter issues:

1. Check this documentation
2. Review Alembic logs
3. Use `python scripts/migrate.py validate`
4. Ask the team in #development channel
5. Create an issue in the repository

---

**Remember:** Database migrations are critical operations. Always test thoroughly and have rollback plans ready! üõ°Ô∏è